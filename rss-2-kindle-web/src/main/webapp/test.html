<!DOCTYPE html>
<html lang="en">
<head>
    <title>RSS-2-KINDLE Profile</title>
    <meta name="viewport" content="width = device-width, initial-scale = 1.0">

    <!-- Custom fonts for this template -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- Bootstrap -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom css -->
    <link href="css/sticky-footer.css" rel="stylesheet">
    <link href="css/simple-sidebar.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="css/freelancer.min.css" rel="stylesheet">

</head>

<body>
<script>
    var rootURL = 'http://localhost:8080/rss2kindle/rest/profile/';
    var username="euro";
    var userData={
        "_id" : "8a60e197-3ad8-4581-83e5-09c17bd3ee96" ,
        "username" : "test" ,
        "password" : "test" ,
        "dateCreated" : "2017-11-13" ,
        "status" : "active" ,
        "subscribers" :
            [
                {
                    "email" : "test@gmail.com" ,
                    "name" : "test" ,
                    "rsslist" :
                        [
                            { "rss" : "test.org/feed" ,
                                "status" : "active"}
                        ] ,
                    "settings" : {
                        "starttime" : "2017-11-13" ,
                        "timeout" : "24"
                    } ,
                    "status" : "active"
                },
                {
                    "email" : "test1@gmail.com" ,
                    "name" header: "test" ,
                    "rsslist" :
                        [
                            { "rss" : "test.org/feed" ,
                                "status" : "active"}
                        ] ,
                    "settings" : {
                        "starttime" : "2017-11-13" ,
                        "timeout" : "24"
                    } ,
                    "status" : "active"
                }
            ] ,
        "roles" : [ "ROLE_USER"]
    };

    $(document).ready(function () {
        //add new subscriber on submit
        $('#new_subscriber_form').submit(function (e) {
            e.preventDefault();
            var email = $('#new_subscriber_email').val();
            var name = $('#new_subscriber_name').val();
            var status = $('#new_subscriber_status').val();

            //create validation popovers
            $('#new_subscriber_email').popover(
                {
                    content: 'Subscriber with such email already exists',
                    trigger: 'manual',
                    placement: 'bottom auto'
                });
            $('#new_subscriber_rsslist').popover(
                {
                    content: 'At least one RSS is required',
                    trigger: 'manual',
                    placement: 'top auto'
                });

            //validate email
            var isEmailValid = true;
            $.each(userData.subscribers, function (i, item) {
                if (item.email === email) {
                    console.log(item.email);
                    $('#new_subscriber_email').data('bs.popover').options.content='Subscriber with email ' + email + ' already exists';
                    isEmailValid = false;

                    return false;
                }
            });
            if (!isEmailValid) {
                $('#new_subscriber_email').popover('show');
                return false;
            }
            $('#new_subscriber_email').popover('hide');
            //validate rss list
            if ($('#new_subscriber_rsslist option').length === 0) {
                $('#new_subscriber_rsslist').popover('show');

                return false;
            }
            $('#new_subscriber_rsslist').popover('hide');
            console.log("Why we are here?");
            var updateJson = '{' +
                'email: "' + email + '",' +
                'name: "' + name + '",' +
                'status: "active",' +
                'rsslist: [ ';
            $('#new_subscriber_rsslist option').each(function () {
                updateJson += '{ rss: "' + $(this).val() + '", status: "active"},';
            });
            updateJson = updateJson.substr(0, updateJson.length - 1) + ']}';

            $.ajax({
                url: rootURL + username + '/new',
                contentType: 'application/json',
                type: 'PUT',
                data: updateJson,
                dataType: 'json',
                headers: csrf_headers
            })
                .done(function () {
                    showAlert('success', 'New subscriber <strong>' + name + '</strong> has been added successfully');
                    return true;
                })
                .fail(function () {
                    showAlert('error', 'New subscriber <strong>' + name + '</strong> creation fail');
                    return false;
                })
                .always(function () {
                    reloadSubscribersTable();
                });
        });

        $('#btn_new_subscriber_addrss').click(function (event) {
            var rss = $('#new_subscriber_addrss').val();
            $('#new_subscriber_addrss').popover('destroy');
            if (validateURL(rss))
                $('#new_subscriber_rsslist').append('<option value = "' + rss + '">' + rss + '</option>');
            else {
                $('#new_subscriber_addrss').popover(
                    {
                        content: rss + ' does not look like a valid URL. Please correct it and try again',
                        trigger: 'manual',
                        placement: 'top auto',
                        delay: {"show": 5000, "hide": 20000}
                    });
                $('#new_subscriber_addrss').popover('show');
                //                alert(rss + " does not look like a valid URL. Please correct it and try again");
            }
        });

        $('#btn_new_subscriber_deleterss').click(function (event) {
            $('#new_subscriber_rsslist option:selected').remove();
        });
    });

    function getUserData() {
        return userData;
    }

    function validateURL(url) {
        var regexp = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g;
        return url.match(regexp);
    }
    function showAlert(type, text) {
        if (type == 'error') {
            $('#alerts_panel').html('<div class="alert alert-danger alert-dismissible" role="alert">'
                + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                + '<strong>Error! </strong>' + text + '</div>');
        } else if (type == 'warning') {
            $('#alerts_panel').html('<div class="alert alert-warning alert-dismissible" role="alert">'
                + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                + '<strong>Warning! </strong>' + text + '</div>');
        } else {
            $('#alerts_panel').html('<div class="alert alert-success alert-dismissible" role="alert">'
                + '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                + '<strong>Success! </strong> ' + text + '</div>');
        }
    }

</script>

<div class="container-fluid">
    <header class="header row">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg bg-secondary fixed-top text-uppercase" id="mainNav">
            <div class="container">
                <a class="navbar-brand js-scroll-trigger" href="#">RSS-2-KINDLE</a>
                <button class="navbar-toggler navbar-toggler-right text-uppercase bg-primary text-white rounded" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fa fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <form id="logout" action="" method="post">
                    <ul class="navbar-nav ml-auto">
                        <li class = "nav-item dropdown active mx-0 mx-lg-1">
                            <a class="nav-link dropdown-toggle py-3 px-0 px-lg-3 rounded js-scroll-trigger" id="navbarDropdownMenuLink" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">
                                <%=username%> <span class="caret"></span>
                            </a>
                            <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="javascript:{}" onclick="document.getElementById('logout').submit(); return false;">Log out</a>
                            </div>
                        </li>
                        <li class="nav-item mx-0 mx-lg-1">
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="../index.html#portfolio">Portfolio</a>
                        </li>
                        <li class="nav-item mx-0 mx-lg-1">
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="../index.html#about">About</a>
                        </li>
                        <li class="nav-item mx-0 mx-lg-1">
                            <a class="nav-link py-3 px-0 px-lg-3 rounded js-scroll-trigger" href="../index.html#contact">Contact</a>
                        </li>
                    </ul>
                    </form>
                </div>
            </div>
        </nav>
    </header>


    <div id="wrapper" class="row">
        <aside id="sidebar-wrapper">
            <ul class="nav nav-pills nav-stacked sidebar-nav">
                <li role="presentation" class="active"><a href="#">My Profile</a></li>
                <li role="presentation"><a href="subscribers">Subscriber Management</a></li>
                <li role="presentation"><a href="service">Services</a></li>
            </ul>
        </aside>
        <main id="page-content-wrapper">
            <div class="container-fluid">
            <h1 class="page-header"><%=username%> dashboard</h1>
            <section class="row text-center placeholders">
                <div class="col-md-4 col-sm-4 placeholder" style="background-color: #c7ddef; border-radius: 70%">
                    <div id="dashboard_user_data">
                        <h4>Status: active</h4>
					</div>
                    <h3>User info</h3>
                    <div class="text-muted" id="dashboard_user_info" >
						Created: 2018-20-27 18:25:67 <br>
						Modified: 2018-20-27 18:25:67 <br>
						Last logged in: 2018-20-27 18:25:67
					</div>
                </div>
                <div class="col-md-4 col-sm-4 placeholder" style="background-color: #f0ad4e; border-radius: 70%">
                    <div id="dashboard_subscribers_data">
                        <h4>Number of subscribers: 2</h4>
                    </div>
                    <h3>Subscribers</h3>
                    <div class="text-muted">
                        Something else <br>
                        something else again <br>
                        again
                    </div>
                </div>
                <div class="col-md-4 col-sm-4 placeholder" style="background-color: #c9e2b3 ">
                    <div id="dashboard_subscriptions_data">
                        <h4>Number of subscriptions: 7</h4>
                    </div>
                    <h3>Subscriptions</h3>
                    <div class="text-muted">
                        Something else <br>
                        something else again <br>
                        again
                    </div>
                </div>
            </section>
            <section class="row placeholders">
                <div class="col-lg-6 placeholder text-left" id="profile_view">
                    <h2 class="sub-header">Subscribers</h2>
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Subscriber</th>
                            <th>email</th>
                            <th>status</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr class="active">
                            <td>1</td>
                            <td>My Kindle</td>
                            <td>dshjs@jdks.ru</td>
                            <td>active</td>
                        </tr>
                        <tr class="danger">
                            <td>2</td>
                            <td>My Kindle</td>
                            <td>dshjs@jdks.ru</td>
                            <td>active</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-lg-6 placeholder text-left">
                    <h2 class="sub-header">Subsriptions</h2>
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Subscription</th>
                            <th>status</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>1</td>
                            <td>http://jdkfjdk.ru</td>
                            <td>active</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>http://kjhdkfhk.rui</td>
                            <td>active</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>http://kjhdkfhk.rui</td>
                            <td>failed</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </section>
    <section>
        <form method="get" id="new_subscriber_form" action="#">
            <div class="form-group">
                <label for="new_subscriber_email">Email</label>
                <input type="email" id="new_subscriber_email" required class="form-control"/>
            </div>
            <div class="form-group">
                <label for="new_subscriber_name">Name</label>
                <input type="text" id="new_subscriber_name" required class="form-control"/>
            </div>
            <div class="form-group">
                <label for="new_subscriber_rsslist">Subscriptions</label>
                <select class="form-control" id="new_subscriber_rsslist" size="5"></select>
                <div class="form-group">
                    <label for="new_subscriber_addrss" class="control-label">Add new subscription
                        (RSS):</label>
                    <input type="url" class="form-control" id="new_subscriber_addrss"/>
                    <div class="btn-group-xs" role="group">
                        <button type="button" class="btn btn-primary" id="btn_new_subscriber_addrss">+
                        </button>
                        <button type="button" class="btn btn-primary" id="btn_new_subscriber_deleterss">
                            -
                        </button>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary"/>
            </div>
        </form>
    </section>
        </div>
        </main>
    </div>

</div>

<!-- JQuery -->
<script src="vendor/jquery/jquery.js"></script>

<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Custom scripts for this template -->
<script src="js/freelancer.min.js"></script>
</body>
</html>